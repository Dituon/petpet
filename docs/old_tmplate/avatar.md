### 头像

程序支持复杂的图像处理, 包括裁切, 旋转, 透明度, 滤镜等

```jsonc
{
  "avatar": [
    {
      "type": "FROM",
      "pos": [[92, 64, 40, 40], [135, 40, 40, 40], [84, 105, 40, 40]],
      "round": true,
      "rotate": false,
      "avatarOnTop": true,
      "angle": 90
    },
    {
      "type": "TO",
      "pos": [[5, 8], [60, 90], [50, 90], [50, 0], [60, 120]],
      "posType": "DEFORM",
      "opacity": 0.5
    }
  ]
}
```

| **属性**          | **类型**  | **注释**                      | **默认值**   |
|-----------------|---------|-----------------------------|-----------|
| **type**        | 头像类型枚举  | 见下文, 例如`FROM`或`TO`          | 必须        |
| **pos**         | 坐标数组    | 头像的坐标信息                     | 必须        |
| **posType**     | 坐标格式枚举  | 坐标格式枚举, `ZOOM`或`DEFORM`     | `ZOOM`    |
| **round**       | 布尔值     | 头像是否裁切为圆形                   | `false`   |
| **avatarOnTop** | 布尔值     | 头像图层是否在背景之上                 | `true`    |
| **angle**       | 整数      | 头像的初始角度                     | `0`       |
| **origin**      | 旋转原点枚举  | 头像的旋转原点                     | `DEFAULT` |
| **opacity**     | 浮点数     | 头像的不透明度                     | `1.0`     |
| **rotate**      | 布尔值     | GIF类型的头像是否旋转                | `false`   |
| **fit**         | 填充模式枚举  | 填充模式枚举, 可以是`CONTAIN`或`FILL` | `FILL`    |
| **crop**        | 裁切坐标数组  | 头像裁切坐标信息                    | `null`    |
| **cropType**    | 裁切格式枚举  | 见下文                         | `NONE`    |
| **style**       | 风格化枚举数组 | 风格化枚举数组, 见下文                | `[]`      |
| **filter**      | 滤镜对象数组  | 滤镜数组, 见下文                   | `[]`      |
| **antialias**   | 布尔值     | 是否使用抗锯齿算法, 默认跟随全局配置         | `null`    |
| **resampling**  | 布尔值     | 是否使用重采样缩放, 默认跟随全局配置         | `null`    |


**头像类型枚举 `type`**

- `FROM`  发送者头像
- `TO`  接收者头像, 或构造的图片
- `GROUP`  群头像
- `BOT`  机器人头像
- `RANDOM`  随机头像 (随机从群聊成员中选择, 不会重复)

#### 坐标

**坐标格式枚举`posType`**

- `ZOOM`  缩放, 通过 x, y, width, height 表示图像
- `DEFORM`  变形, 通过四点坐标来表示图像

###### ZOOM

`ZOOM` 缩放坐标的基本组成单位是 4长度 `int[]` 数组

其中，前两项为 **左上角顶点坐标**， 后两项为 **宽度和高度**

例:
`[65, 128, 77, 72]` 即 头像的左上角顶点坐标是 `(65,128)`, 宽度为 `77`, 高度为 `72`

如果是 `GIF` 类型，坐标应为二维数组，`GIF` 的每一帧视为单个图像文件

```json lines
 {
  // pos的元素对应GIF的4帧
  "pos": [[65, 128, 77, 72], [67, 128, 73, 72], [54, 139, 94, 61], [57, 135, 86, 65]]
}
```

如果是`IMG`类型, 可以使用一维数组

```json lines
{
  "pos": [0, 0, 200, 200]
}
```

坐标支持变量运算, 例如 `[100,100,"width/2","height*1.5^2"]`

**坐标变量**

- `width`  原图宽度
- `height`  原图高度

###### DEFORM

`DEFORM` 仿射变换坐标格式为 `[[x1,y1],[x2,y2],[x3,y3],[x4,y4],[,y_anchor]]`;
分别对应图片的`[[左上角],[左下角],[右下角],[右上角],[锚点]]`，四角坐标用相对于锚点的偏移量表示

**旋转原点枚举 `origin`**

- `DEFAULT` 左上角
- `CENTER` 中心

#### 裁切

图片裁切坐标 `[x1, y1, x2, y2]`, `[0, 0, x2, y2]` 可简写为 `[x2, y2]`

**裁切格式枚举 `cropType`**

- `NONE`  不裁切
- `PIXEL`  按像素裁切
- `PERCENT`  按百分比裁切

**填充模式 `fit`**

- `CONTAIN` 缩小以适应画布, 不改变原比例
- `COVER` 裁切以适应画布, 不改变原比例
- `FILL` 拉伸, 改变原比例

**风格化枚举 `style`**

- `MIRROR`  水平镜像
- `FLIP`  上下翻转
- `GRAY`  灰度化
- `BINARIZATION`  二值化

#### 滤镜 `filter`

通过滤镜实现头像特效, Java 与 JavaScript 版本实现有偏差, 并非完全相同

```json
{
  "filter": [
    {
      "type": "SWIRL",
      "radius": 200,
      "angle": 5.0
    }
  ]
}
```

滤镜可使用数组实现动画, 例如:

```json lines
{
  "type": "GIF",
  "background": {
    "length": 5, // GIF 长度是 5 帧
    "size": ["avatar0Width", "avatar0Height"] // 画布的尺寸为第一个头像的尺寸
  },
  "avatar": [{
    "type": "TO",
    "pos": [0, 0, "width", "height"], // 图像占满画布
    //省略...
    "filter": [{
      "type": "SWIRL",
      "angle": [0, 1.2, 2.4, 3.6, 4.8] // 对应每一帧的动画
    }]
  }]
  //省略...
}
```

<details><summary>实现差异对比</summary>

![实现差异对比](https://s2.loli.net/2023/11/01/n5dZ2SyQkNFWzCu.jpg)

</details>

##### 滤镜参数

- `SWIRL` , 漩涡滤镜

| **属性**     | **类型** | **注释**           | **默认值** |
|------------|--------|------------------|---------|
| **radius** | 浮点数    | 涡旋半径, 值为0时表示图片半径 | `0.0`   |
| **angle**  | 浮点数    | 涡旋角度             | `3.0`   |
| **x**      | 浮点数    | 中心点X坐标百分比        | `0.5`   |
| **y**      | 浮点数    | 中心点Y坐标百分比        | `0.5`   |

- `BULGE` , 膨胀收缩滤镜

| **属性**       | **类型** | **注释**                    | **默认值** |
|--------------|--------|---------------------------|---------|
| **radius**   | 浮点数    | 膨胀半径, 值为0时表示图片半径          | `0.0`   |
| **strength** | 浮点数    | 膨胀强度 `[-1, 1]`, 负数时产生收缩效果 | `0.5`   |
| **x**        | 浮点数    | 中心点X坐标百分比                 | `0.5`   |
| **y**        | 浮点数    | 中心点Y坐标百分比                 | `0.5`   |

- `SWIM` , 水下滤镜

| **属性**         | **类型** | **注释** | **默认值** |
|----------------|--------|--------|---------|
| **scale**      | 浮点数    | 缩放系数   | `32.0`  |
| **stretch**    | 浮点数    | 拉伸系数   | `1.0`   |
| **angle**      | 浮点数    | 角度     | `0.0`   |
| **amount**     | 浮点数    | 强度     | `10.0`  |
| **turbulence** | 浮点数    | 湍流系数   | `1.0`   |
| **time**       | 浮点数    | 时间     | `0.0`   |

- `BLUR` , 模糊滤镜

| **属性**     | **类型** | **注释** | **默认值** |
|------------|--------|--------|---------|
| **radius** | 浮点数    | 模糊半径   | `10.0`  |

- `CONTRAST` , 亮度对比度滤镜

| **属性**         | **类型** | **注释** | **默认值** |
|----------------|--------|--------|---------|
| **brightness** | 浮点数    | 亮度     | `0.0`   |
| **contrast**   | 浮点数    | 对比度    | `0.0`   |

- `HSB` , 相对HSB (色相, 饱和度, 亮度) 滤镜

| **属性**         | **类型** | **注释** | **默认值** |
|----------------|--------|--------|---------|
| **hue**        | 浮点数    | 色相     | `0.0`   |
| **saturation** | 浮点数    | 饱和度    | `0.0`   |
| **brightness** | 浮点数    | 亮度     | `0.0`   |

- `HALFTONE` , 半色调滤镜 (模仿彩色印刷的CMYK色彩)

| **属性**     | **类型** | **注释**    | **默认值** |
|------------|--------|-----------|---------|
| **angle**  | 浮点数    | 角度        | `0.0`   |
| **radius** | 浮点数    | 半径        | `4.0`   |
| **x**      | 浮点数    | 中心点X坐标百分比 | `0.5`   |
| **y**      | 浮点数    | 中心点Y坐标百分比 | `0.5`   |

- `DOT_SCREEN` , 单色点阵滤镜 (模仿黑白印刷品)

| **属性**     | **类型** | **注释**    | **默认值** |
|------------|--------|-----------|---------|
| **angle**  | 浮点数    | 角度        | `0.0`   |
| **radius** | 浮点数    | 半径        | `4.0`   |
| **x**      | 浮点数    | 中心点X坐标百分比 | `0.5`   |
| **y**      | 浮点数    | 中心点Y坐标百分比 | `0.5`   |

- `NOISE` , 噪声滤镜

| **属性**     | **类型** | **注释** | **默认值** |
|------------|--------|--------|---------|
| **amount** | 浮点数    | 噪声强度   | `0.25`  |

- `DENOISE` , 降噪滤镜

| **属性**       | **类型** | **注释** | **默认值** |
|--------------|--------|--------|---------|
| **exponent** | 浮点数    | 指数     | `20.0`  |

- `OIL` , 油画滤镜

| **属性**     | **类型** | **注释** | **默认值** |
|------------|--------|--------|---------|
| **skip**   | 浮点数    | 迭代跨越系数 | `4.0`   |
| **range**  | 浮点数    | 迭代范围   | `12.0`  |
| **levels** | 浮点数    | 等级     | `8.0`   |