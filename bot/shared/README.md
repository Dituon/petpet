# Petpet Bot Shared

## 匹配逻辑

为保证不同实现有相同的用户体验, Bot 实例应在默认配置下遵循相同的指令解析逻辑:

- `pet` 发送默认模板
- `pet <id>` 发送指定模板
- `pet <target>` 发送随机模板
- `<id>` 发送指定模板

### 构建图像参数

1. **基本构建规则**

   消息中的元素按以下顺序解析并构建参数列表：

    ```text
    <bot> <sender> <...target> <reply>
    ```

    - **`<bot>`**: 机器人头像
    - **`<sender>`**: 消息发送者头像
    - **`<target>`**: 消息中的图像或被 At 的目标头像
    - **`<reply>`**: 回复消息中的第一个图像

2. **特殊规则**

    - **回复消息调整**:  
      如果消息是对其他消息的回复，并且回复的目标消息中包含图像，则从最终参数列表中移除最后一个 At
      目标为 `<回复消息发送者>` 的元素。
        - **原因**: 在 QQ 群聊中，回复消息时默认会将 `<回复消息发送者>` 添加为 At 目标，但这通常不符合用户预期。
    - 如果最终参数列表的长度 **≥ 4**，移除列表最前面的 `<bot>` 与 `<sender>` 元素。
    - 如果最终参数列表的长度 **= 3**，仅移除最前面的 `<bot>` 元素。

3. **其它参数**

    - **`from`**:
      参数列表倒数第二个元素

    - **`to`**:
      参数列表最后一个元素

    - **`bot`**:
      机器人头像
   
    - **`group`**:
      群头像

   构建的参数列表可在模板中通过 `key` 引用, 例如:

    - `key: "0"`: 参数列表下标为 0 的元素
    - `key: "1"`: 参数列表下标为 1 的元素
    - `key: "from"`: 参数列表最后一个元素
    - `key: "to"`: 参数列表倒数第二个元素

其它参数:

### 构建文本参数

1. **基本构建规则**

    - 文本中的元素以一个或多个空格分割。
    - 原始文本的完整内容存储为参数 `"raw"`。

2. **其它参数**

    - **`"from"` & `"to"`**:  
      表示上文构建的图像参数中选择的目标用户名:
        - 如果目标是发送或回复的图像，则值为 `"这个"`。

    - **`"from_id"` & `"to_id"`**:  
      表示上文构建的图像参数中选择的目标用户 ID:
        - 如果目标是发送或回复的图像，则值为 `"0"`。
    
    - **`"bot"`**:
      机器人昵称
    
    - **`"group"`**:
      群名称

    - **`"raw"`**:
      原始文本内容。
